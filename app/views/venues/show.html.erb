<h1><%= @venue.venue_name %></h1>
<p><%= @venue.description %></p>

<% if @venue.deletable_by(current_user) %>
  <%= button_to "Delete Venue", venue_path, class: "button", method: "delete", label: "Delete Venue"%>
<% end %>
<% if @venue.deletable_by(current_user) %>
  <%= button_to "Edit Venue", edit_venue_path, class: "button", method: "get", label: "Edit Venue"%>
<% end %>

<ul>
  <% @reviews.each do |review| %>
<div id="review-<%= review.id %>"
    <li> <%= review.review_body %></li>
    <%= review.rating %>
  <div class="helpful">Helpful: <%= review.revup_count %></div>
  <div class="not-helpful">Not Helpful: <%= review.revdown_count %></div>
  <div class="upvote">
    <%= button_to "helpful", "/api/venues/#{@venue.id}/reviews/#{review.id}", method:"patch", params: {up: "true", load_javascript: "false"} %>
  </div>
  <div class="downvote">
    <%= button_to "not helpful", "/api/venues/#{@venue.id}/reviews/#{review.id}", method:"patch", params: {down: "true", load_javascript: "false"}%>
  </div>
  </div>
  <% if review.deletable_by(current_user) %>
  <%= button_to "Delete Review", venue_review_path(@venue, review), class: "button", method: "delete", label: "Delete Review" %>
  <% end %>
  <% if review.deletable_by(current_user) %>
  <%= button_to "Edit Review", edit_venue_review_path(@venue, review), class: "button", method: "get", label: "Edit Review" %>
  <% end %>
  <% end %>
</ul>
</div>

<div class="text-center">
  <a href="<%= new_venue_review_path(@venue) %>" class="button">Add a New Review</a>
</div>

<div class="text-center">
  <a href="<%= venues_path %>" class="button">All Venues</a>
</div>

<script>
var makeAjaxRequestUpPost = function(reviewButtonTo, venueID, reviewId, voteType) {
  var request = $.ajax({
    method: 'PATCH',
    data: { up: voteType, load_javascript: "true" },
    url: '/api/venues/' + venueID + '/reviews/' + reviewId
  });

  request.done(function(data) {
    var review = $('#review-' + data.id)[0]
    review.getElementsByClassName("helpful")[0].innerHTML = "Helpful: " + data.revup_count
    review.getElementsByClassName("not-helpful")[0].innerHTML = "Not Helpful: " + data.revdown_count
  });
};

var makeAjaxRequestDownPost = function(reviewButtonTo, venueID, reviewId, voteType) {
  var request = $.ajax({
    method: 'PATCH',
    data: { down: voteType,load_javascript: "true" },
    url: '/api/venues/' + venueID + '/reviews/' + reviewId
  });

  request.done(function(data) {
    var review = $('#review-' + data.id)[0]
    review.getElementsByClassName("helpful")[0].innerHTML = "Helpful: " + data.revup_count
    review.getElementsByClassName("not-helpful")[0].innerHTML = "Not Helpful: " + data.revdown_count
  });
};

$('.upvote').on('click', function(event) {
    event.preventDefault();
    var reviewButton = event.target;
    var venueId = reviewButton.baseURI.match(/^(.*?)(\d+)(\D*)$/)[2];
    var reviewButtonTo = $(reviewButton).closest('.button_to');
    var reviewId = $(reviewButtonTo).attr('action').match(/^(.*?)(\d+)(\D*)$/)[2];
    var voteType = "true";

    makeAjaxRequestUpPost(reviewButtonTo, venueId, reviewId, voteType)
  });

$('.downvote').on('click', function(event) {
    event.preventDefault();
    var reviewButton = event.target;
    var venueId = reviewButton.baseURI.match(/^(.*?)(\d+)(\D*)$/)[2];
    var reviewButtonTo = $(reviewButton).closest('.button_to');
    var reviewId = $(reviewButtonTo).attr('action').match(/^(.*?)(\d+)(\D*)$/)[2];
    var voteType = "true";

    makeAjaxRequestDownPost(reviewButtonTo, venueId, reviewId, voteType)
  });
</script>
